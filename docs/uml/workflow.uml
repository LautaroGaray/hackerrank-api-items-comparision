@startuml Item Creation Workflow

actor Client
participant ItemController
participant ItemService
participant ItemValidator
participant SpecificationValidator
participant ItemRepository
database Database

== Create Item (ID Auto-generated) ==

Client -> ItemController: POST /items\n(CreateItemRequest without ID)
activate ItemController

note right of ItemController
  CreateItemRequest includes:
  - name, imageUrl, description
  - price, rating
  - specification (optional)
  
  NO ID field in request
end note

ItemController -> ItemController: Convert DTO to Item\n(without ID)
ItemController -> ItemService: createItem(itemWithoutId)
activate ItemService

ItemService -> ItemValidator: validate(item)
activate ItemValidator

ItemValidator -> ItemValidator: validateNotNull(item)
ItemValidator -> ItemValidator: validateName(name)
ItemValidator -> ItemValidator: validatePrice(price)
ItemValidator -> ItemValidator: validateRating(rating)

ItemValidator -> SpecificationValidator: validate(specification)
activate SpecificationValidator

alt Specification is not null
    SpecificationValidator -> SpecificationValidator: validateBrand(brand)
    SpecificationValidator -> SpecificationValidator: validateWeight(weight)
    SpecificationValidator -> SpecificationValidator: validateWarrantyMonths(warrantyMonths)
else Specification is null
    SpecificationValidator --> ItemValidator: OK (null is valid)
end

SpecificationValidator --> ItemValidator: Validation OK
deactivate SpecificationValidator

ItemValidator --> ItemService: Validation OK
deactivate ItemValidator

ItemService -> ItemService: Generate UUID for item
note right of ItemService
  Uses UUID.randomUUID()
  to generate unique ID
end note

ItemService -> ItemService: item = item.withId(generatedId)

ItemService -> ItemRepository: save(itemWithId)
activate ItemRepository

ItemRepository -> Database: INSERT INTO items\n(id, name, price, rating,\nspecification, ...)
Database --> ItemRepository: Item saved
ItemRepository --> ItemService: Return saved item
deactivate ItemRepository

ItemService --> ItemController: Return item with ID
deactivate ItemService

ItemController --> Client: HTTP 200\nItem with generated ID
deactivate ItemController

== Update Item (ID Required) ==

Client -> ItemController: PUT /items\n(Item with ID)
activate ItemController

note right of ItemController
  Update request MUST include:
  - id (existing item)
  - all other fields
  - specification (optional)
end note

ItemController -> ItemService: updateItem(item)
activate ItemService

ItemService -> ItemValidator: validateNotNull(item)
ItemService -> ItemValidator: validateIdNotNull(item.id())

ItemService -> ItemRepository: findById(id)
activate ItemRepository
ItemRepository -> Database: SELECT * FROM items WHERE id = ?
Database --> ItemRepository: Item found
ItemRepository --> ItemService: Optional<Item>
deactivate ItemRepository

alt Item exists
    ItemService -> ItemValidator: validate(item)
    activate ItemValidator
    ItemValidator -> SpecificationValidator: validate(specification)
    activate SpecificationValidator
    SpecificationValidator --> ItemValidator: OK
    deactivate SpecificationValidator
    ItemValidator --> ItemService: OK
    deactivate ItemValidator
    
    ItemService -> ItemRepository: save(item)
    activate ItemRepository
    ItemRepository -> Database: UPDATE items SET ...\nWHERE id = ?
    Database --> ItemRepository: Updated
    ItemRepository --> ItemService: Updated item
    deactivate ItemRepository
    
    ItemService --> ItemController: Updated item
else Item not found
    ItemService --> ItemController: ItemNotFoundException
end

ItemController --> Client: HTTP 200\nUpdated item
deactivate ItemService
deactivate ItemController

== Get Item ==

Client -> ItemController: GET /items/{id}
activate ItemController

ItemController -> ItemService: getItemById(id)
activate ItemService

ItemService -> ItemValidator: validateIdNotNull(id)
ItemService -> ItemRepository: findById(id)
activate ItemRepository

ItemRepository -> Database: SELECT * FROM items\nWHERE id = ?
Database --> ItemRepository: Item with specification

ItemRepository --> ItemService: Optional<Item>
deactivate ItemRepository

alt Item exists
    ItemService --> ItemController: Item (with specification)
else Item not found
    ItemService --> ItemController: ItemNotFoundException
end

deactivate ItemService

ItemController --> Client: HTTP 200\nItem with specification
deactivate ItemController

== Compare Items ==

Client -> ItemController: GET /items/compare?id1=x&id2=y
activate ItemController

ItemController -> ItemService: compare(id1, id2)
activate ItemService

ItemService -> ItemRepository: findById(id1)
activate ItemRepository
ItemRepository -> Database: SELECT * FROM items WHERE id = id1
Database --> ItemRepository: Item1
ItemRepository --> ItemService: Item1
deactivate ItemRepository

ItemService -> ItemRepository: findById(id2)
activate ItemRepository
ItemRepository -> Database: SELECT * FROM items WHERE id = id2
Database --> ItemRepository: Item2
ItemRepository --> ItemService: Item2
deactivate ItemRepository

ItemService -> ItemService: Calculate best price
ItemService -> ItemService: Calculate best rating
ItemService -> ItemService: Calculate differences

note right of ItemService
  Comparison considers:
  - Price comparison
  - Rating comparison
  - Specification differences
  - Additional metadata
end note

ItemService --> ItemController: ComparisionResult
deactivate ItemService

ItemController --> Client: HTTP 200\nComparisionResult
deactivate ItemController

== Delete Item ==

Client -> ItemController: DELETE /items/{id}
activate ItemController

ItemController -> ItemService: deleteItem(id)
activate ItemService

ItemService -> ItemValidator: validateIdNotNull(id)
ItemService -> ItemRepository: findById(id)
activate ItemRepository
ItemRepository --> ItemService: Optional<Item>
deactivate ItemRepository

alt Item exists
    ItemService -> ItemRepository: deleteById(id)
    activate ItemRepository
    ItemRepository -> Database: DELETE FROM items WHERE id = ?
    Database --> ItemRepository: Deleted
    ItemRepository --> ItemService: void
    deactivate ItemRepository
    
    ItemService --> ItemController: void
else Item not found
    ItemService --> ItemController: ItemNotFoundException
end

deactivate ItemService

ItemController --> Client: HTTP 200
deactivate ItemController

@enduml